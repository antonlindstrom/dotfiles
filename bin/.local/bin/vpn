#!/bin/bash

# Setup the VPN connection.
function up() {
  systemctl start openswan
  sleep 2
  systemctl start xl2tpd
  ipsec auto --add L2TP-PSK
  ipsec auto --up L2TP-PSK
  echo "c vpn-connection" > /var/run/xl2tpd/l2tp-control
}

# Tear down the VPN connection.
function down() {
  ipsec auto --down L2TP-PSK
  systemctl stop openswan
  systemctl stop xl2tpd
  echo "" > /var/run/xl2tpd/l2tp-control
}

# Main.
#
# --up    Start VPN.
# --down  Stop VPN.
#
case $1 in
  up)
    if (( $EUID != 0 )); then
      echo "This requires superuser abilities (run with sudo)."
      echo "Try: sudo vpn up"
      exit 1
    fi

    echo "=> Starting VPN..."
    up
    ;;
  down)
    if (( $EUID != 0 )); then
      echo "This requires superuser abilities (run with sudo)."
      echo "Try: sudo vpn down"
      exit 1
    fi

    echo "=> Stopping VPN..."
    down
    ;;
  *)
    echo "Usage:"
    echo "  vpn up    - Start VPN (default configuration)"
    echo "  vpn down  - Tear down VPN connection."
    ;;
esac
