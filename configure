#!/usr/bin/env bash
[[ "${TRACE}" ]] && set -x

configure_bash() {
	grep ".config/bash/config" ~/.bash_profile > /dev/null
	if [ $? == 1 ]; then
		echo "Appending bash configuration sourcing to .bash_profile"
		echo "[[ -f ~/.config/bash/config ]] && . ~/.config/bash/config" >> ~/.bash_profile
	fi

	grep ".config/bash/config" ~/.bashrc > /dev/null
	if [ $? == 1 ]; then
		echo "Appending bash configuration sourcing to .bashrc"
		echo "[[ -f ~/.config/bash/config ]] && .  ~/.config/bash/config" >> ~/.bashrc
	fi
}

configure_env_private() {
	local target=~/.env.private
	[ -f "${target}" ] && return 0

	read -r -p "AWS_ACCESS_KEY_ID: " aws_id
	read -r -p "AWS_SECRET_ACCESS_KEY: " aws_key
	read -r -p "RESTIC_REPOSITORY: " restic_repo
	read -r -p "RESTIC_PASSWORD: " restic_password
	echo

	echo "Writing file '${target}' with content:"
	tee "${target}" <<EOM
export AWS_ACCESS_KEY_ID="${aws_id}"
export AWS_SECRET_ACCESS_KEY="${aws_key}"

export RESTIC_REPOSITORY="${restic_repo}"
export RESTIC_PASSWORD="${restic_password}"
EOM
}

configure_git() {
	local target=~/.gitconfig.private
	[ -f "${target}" ] && return 0

	read -r -p "Name: " name
	read -r -p "E-mail: " email
	echo

	echo "Writing file '${target}' with content:"
	tee "${target}" <<EOM
[user]
	name = ${name}
	email = ${email}
EOM
}

configure_mutt() {
	[ -d ~/.mail_aliases ] || mkdir ~/.mail_aliases
}

configure_offlineimap() {
	local target=~/.offlineimap/password
	[ -d ~/.offlineimap ] || mkdir ~/.offlineimap
	[ -f "${target}" ] && return 0

	read -r -p "Password: " password
	echo

	echo "Writing file '${target}' with content:"
	tee "${target}" <<EOM
${password}
EOM
}

main() {
	echo '==> Append bash config:'
	configure_bash
	echo '==> Configure private environment config:'
	configure_env_private
	echo '==> Create private git config:'
	configure_git
	echo '==> Add mail alias file:'
	configure_mutt
	echo '==> Configure offlineimap password:'
	configure_offlineimap
}

main "$@"
